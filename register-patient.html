<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register | TreatInt</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #f0f0f0; }
        .box { background: white; padding: 30px; max-width: 400px; margin: 0 auto; border-radius: 10px; }
        input { display: block; width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; }
        button { padding: 15px 30px; background: blue; color: white; font-weight: bold; cursor: pointer; border: none; font-size: 16px; }
        button:hover { background: darkblue; }
    </style>
</head>
<body>

    <div class="box">
        <h2>System Test Registration</h2>
        <p>This form will ALERT every step.</p>
        
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <input type="text" id="fullName" placeholder="Full Name">
        <input type="text" id="phone" placeholder="Phone">
        <input type="text" id="country" placeholder="Country">

        <button onclick="runTest()" id="btn">CREATE ACCOUNT</button>
    </div>

    <script>
        // 1. KEYS
        const SUPABASE_URL = 'PASTE_YOUR_PROJECT_URL_HERE'; 
        const SUPABASE_KEY = 'PASTE_YOUR_ANON_KEY_HERE';

        async function runTest() {
            // STEP 1: TEST BUTTON
            alert("Step 1: Button Clicked. Code is running.");

            const btn = document.getElementById('btn');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const country = document.getElementById('country').value;

            // STEP 2: TEST LIBRARY
            if(typeof supabase === 'undefined') {
                alert("CRITICAL ERROR: Supabase library did not load. Check your internet connection.");
                return;
            }

            // STEP 3: INIT CLIENT
            let sb;
            try {
                sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch(e) {
                alert("Error initializing Supabase. Did you paste your keys?");
                return;
            }

            // STEP 4: SEND AUTH
            alert("Step 2: Sending data to Supabase Auth...");
            btn.innerText = "Working...";

            const { data: authData, error: authError } = await sb.auth.signUp({
                email: email,
                password: password
            });

            if (authError) {
                alert("AUTH ERROR: " + authError.message);
                btn.innerText = "Failed";
                return;
            }

            if (!authData.user) {
                alert("Auth finished but no User returned. Did you disable 'Confirm Email' in Supabase?");
                btn.innerText = "Stuck";
                return;
            }

            alert("Step 3: Auth Success! User ID: " + authData.user.id);

            // STEP 5: SAVE TO DB
            alert("Step 4: Saving profile to Database...");

            const { error: dbError } = await sb
                .from('patients')
                .insert([{ 
                    id: authData.user.id,
                    name: name,
                    phone: phone, 
                    location: country 
                }]);

            if (dbError) {
                alert("DATABASE ERROR: " + dbError.message + "\n\nHint: Check your table columns or RLS settings.");
                btn.innerText = "DB Failed";
                return;
            }

            // SUCCESS
            alert("SUCCESS! Everything worked. Redirecting...");
            window.location.href = 'dashboard-patient.html';
        }
    </script>
</body>
</html>
