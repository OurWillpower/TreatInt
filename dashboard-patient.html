<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Debugger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #333; color: #0f0; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #444; padding: 5px 0; }
        .error { color: #ff4444; font-weight: bold; }
        .success { color: #00ff00; }
        .warning { color: orange; }
    </style>
</head>
<body>

    <h2>ðŸ›‘ SYSTEM DIAGNOSTICS ðŸ›‘</h2>
    <div id="console-log">Waiting for script...</div>

    <script>
        const logger = document.getElementById('console-log');
        function log(msg, type = 'normal') {
            const time = new Date().toLocaleTimeString();
            let color = type === 'error' ? 'red' : (type === 'success' ? '#0f0' : '#ccc');
            logger.innerHTML += `<div class="log-entry" style="color:${color}">[${time}] ${msg}</div>`;
        }

        // --- STEP 1: CHECK KEYS ---
        // ******************************************************
        // PASTE YOUR KEYS HERE CAREFULLY
        // ******************************************************
        const SUPABASE_URL = 'PASTE_YOUR_PROJECT_URL_HERE'; 
        const SUPABASE_KEY = 'PASTE_YOUR_ANON_KEY_HERE';

        log("1. Starting System Check...");

        // --- STEP 2: CHECK LIBRARY ---
        if (typeof supabase === 'undefined') {
            log("CRITICAL ERROR: Supabase library not loaded. Check internet connection or CDN.", 'error');
        } else {
            log("2. Supabase Library Found.", 'success');
        }

        // --- STEP 3: INIT CLIENT ---
        let sbClient;
        try {
            sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            log("3. Client Initialized.", 'success');
        } catch (err) {
            log("CRITICAL ERROR: Could not init client. Keys might be wrong format.", 'error');
            console.error(err);
        }

        // --- STEP 4: CHECK SESSION ---
        async function runDiagnostics() {
            log("4. Asking Supabase for Session...", 'warning');
            
            const { data, error } = await sbClient.auth.getSession();

            if (error) {
                log("AUTH ERROR: " + error.message, 'error');
                return;
            }

            if (!data.session) {
                log("RESULT: No User Logged In.", 'error');
                log("Action: You must go to register-patient.html or login.html first.", 'warning');
                log("<br><a href='register-patient.html' style='color:white; font-size:1.5rem;'>CLICK HERE TO REGISTER</a>");
                return;
            }

            log("5. SUCCESS: User is Logged In!", 'success');
            log("User ID: " + data.session.user.id);
            log("User Email: " + data.session.user.email);

            // --- STEP 5: CHECK DATABASE ---
            log("6. Attempting to fetch Profile from DB...", 'warning');
            
            const { data: profile, error: dbError } = await sbClient
                .from('patients')
                .select('*')
                .eq('id', data.session.user.id);

            if (dbError) {
                log("DATABASE ERROR: " + dbError.message, 'error');
                log("Hint: Is the table named 'patients'? Did you disable RLS?", 'warning');
            } else if (profile.length === 0) {
                log("DATABASE RESULT: User exists in Auth, but NO PROFILE found in 'patients' table.", 'error');
                log("This usually means the Registration page logic failed to insert the row.", 'warning');
            } else {
                log("7. FINAL SUCCESS: Profile Found!", 'success');
                log("Name in DB: " + profile[0].name);
                log("Everything is working. You can restore the design code now.", 'success');
            }
        }

        runDiagnostics();
    </script>

</body>
</html>
